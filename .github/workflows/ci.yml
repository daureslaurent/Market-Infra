name: CI

on:
  pull_request:
    branches: [main]
    paths: [ '../../../Market-Spring/src', '../../../Market-Spring/pom.xml', '../../../Market-Spring/backend', '../../../Market-Spring/frontend', '../../terraform' ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # ---------------- Checkout ----------------
      - name: Checkout
        uses: actions/checkout@v4

      # ---------------- Maven Build Backend ----------------
      - name: Maven Build Backend
        run: mvn clean package -DskipTests

      # ---------------- Docker Build Backend ----------------
      - name: Docker Build Backend
        run: docker build -t backend ./backend

      # ---------------- Docker Build Frontend ----------------
      - name: Docker Build Frontend
        run: docker build -t frontend ./frontend

      # ---------------- Terraform Setup ----------------
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform Format
        run: terraform -chdir=terraform fmt -check

      - name: Terraform Init
        run: terraform -chdir=terraform init

      - name: Terraform Validate
        run: terraform -chdir=terraform validate

      - name: Terraform Plan
        id: plan
        run: terraform -chdir=terraform plan -no-color
        env:
          TF_VAR_db_user: dummy
          TF_VAR_db_password: dummy
        continue-on-error: true

      # ---------------- Comment PR ----------------
      - name: Comment PR
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `#### Terraform Plan ðŸ“– \`${{ steps.plan.outcome }}\`

              <details><summary>Show Plan</summary>

              \`\`\`terraform
              ${{ steps.plan.outputs.stdout }}
              \`\`\`

              </details>`
            });