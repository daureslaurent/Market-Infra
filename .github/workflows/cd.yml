name: CD

on:
  push:
    branches: [main]
    paths: [ '../../../Market-Spring/src', '../../../Market-Spring/pom.xml', '../../../Market-Spring/backend', '../../../Market-Spring/frontend', '../../terraform' ]

permissions:
  id-token: write
  contents: read
  pull-requests: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production

    steps:
      # ---------------- Checkout ----------------
      - name: Checkout
        uses: actions/checkout@v4

      # ---------------- AWS Credentials ----------------
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ vars.AWS_ACCOUNT_ID }}:role/GitHubActionsTerraformRole
          aws-region: ${{ vars.AWS_REGION }}

      # ---------------- Maven Build Backend ----------------
      - name: Maven Build Backend
        run: mvn clean package -DskipTests

      # ---------------- Terraform Setup ----------------
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform Init
        run: |
          terraform -chdir=terraform init \
            -backend-config="bucket=${{ vars.TERRAFORM_BACKEND_BUCKET }}" \
            -backend-config="key=terraform.tfstate" \
            -backend-config="region=${{ vars.AWS_REGION }}" \
            -backend-config="dynamodb_table=${{ vars.TERRAFORM_BACKEND_DYNAMODB_TABLE }}"

      - name: Terraform Validate
        run: terraform -chdir=terraform validate

      # ---------------- Docker Login to ECR ----------------
      - name: Login to AWS ECR
        uses: aws-actions/amazon-ecr-login@v1

      # ---------------- Build & Push Backend ----------------
      - name: Build & Push Backend Docker
        run: |
          IMAGE_URI=${{ secrets.ECR_BACKEND_URI }}
          TAG=${{ github.sha }}
          docker build -t backend ./backend
          docker tag backend $IMAGE_URI:$TAG
          docker tag backend $IMAGE_URI:latest
          docker push $IMAGE_URI:$TAG
          docker push $IMAGE_URI:latest

      # ---------------- Build & Push Frontend ----------------
      - name: Build & Push Frontend Docker
        run: |
          IMAGE_URI=${{ secrets.ECR_FRONTEND_URI }}
          TAG=${{ github.sha }}
          docker build -t frontend ./frontend
          docker tag frontend $IMAGE_URI:$TAG
          docker tag frontend $IMAGE_URI:latest
          docker push $IMAGE_URI:$TAG
          docker push $IMAGE_URI:latest

      # ---------------- Terraform Plan ----------------
      - name: Terraform Plan
        id: plan
        run: terraform -chdir=terraform plan -no-color -input=false
        env:
          TF_VAR_image_tag: ${{ github.sha }}
          TF_VAR_backend_bucket: ${{ vars.TERRAFORM_BACKEND_BUCKET }}
          TF_VAR_backend_dynamodb_table: ${{ vars.TERRAFORM_BACKEND_DYNAMODB_TABLE }}
          TF_VAR_db_user: ${{ vars.DB_USER }}
          TF_VAR_db_password: ${{ secrets.DB_PASSWORD }}
        continue-on-error: true

      # ---------------- Terraform Apply ----------------
      - name: Terraform Apply
        run: terraform -chdir=terraform apply -auto-approve
        env:
          TF_VAR_image_tag: ${{ github.sha }}
          TF_VAR_backend_bucket: ${{ vars.TERRAFORM_BACKEND_BUCKET }}
          TF_VAR_backend_dynamodb_table: ${{ vars.TERRAFORM_BACKEND_DYNAMODB_TABLE }}
          TF_VAR_db_user: ${{ vars.DB_USER }}
          TF_VAR_db_password: ${{ secrets.DB_PASSWORD }}