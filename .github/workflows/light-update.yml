name: light-deploy.yml
on:
  repository_dispatch:
    types: [update-backend, update-frontend, update-reverse]

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: check folder
        run: |
          ls -l ./

      - name: Update versions.env
        run: |          
          if [ "${{ github.event.action }}" = "update-backend" ]; then
            sed -i "s#^BACKEND_IMAGE=.*#BACKEND_IMAGE=${{ github.event.client_payload.image }}#" ./light-deploy/versions.env
            sed -i "s#^BACKEND_TAG=.*#BACKEND_TAG=${{ github.event.client_payload.tag }}#" ./light-deploy/versions.env
          fi

          if [ "${{ github.event.action }}" = "update-frontend" ]; then
            sed -i "s#^FRONTEND_IMAGE=.*#FRONTEND_IMAGE=${{ github.event.client_payload.image }}#" ./light-deploy/versions.env
            sed -i "s#^FRONTEND_TAG=.*#FRONTEND_TAG=${{ github.event.client_payload.tag }}#" ./light-deploy/versions.env
          fi

          if [ "${{ github.event.action }}" = "update-reverse" ]; then
            sed -i "s#^REVERSE_PROXY_IMAGE=.*#REVERSE_PROXY_IMAGE=${{ github.event.client_payload.image }}#" ./light-deploy/versions.env
            sed -i "s#^REVERSE_PROXY_TAG=.*#REVERSE_PROXY_TAG=${{ github.event.client_payload.tag }}#" ./light-deploy/versions.env
          fi

      - name: Commit changes
        run: |
          git config user.name "infra-bot"
          git config user.email "infra@bot"
          git add light-deploy/versions.env
          git commit -m "ðŸš¢ Shipping ${{ github.event.client_payload.image }} (${{ github.event.client_payload.tag }})"
          git push
